# 3RRS 并联平台太阳追踪系统

基于 3-RRS 并联机构的太阳追踪控制系统，通过 MATLAB 进行运动学仿真与控制指令生成，经串口传至 STM32F103，驱动 PCA9685 舵机驱动板控制三路舵机。

---

## 系统架构

```
MATLAB (PC)
  ├── sun.m       ← 纯仿真，验证 IK 与 PID 算法
  └── sun211.m    ← 仿真 + 硬件控制（串口输出）
        │  串口 115200 baud
        │  协议: "S1:090\n"
        ▼
STM32F103 (Core/Src/main.c + usart.c)
        │  I2C
        ▼
PCA9685 舵机驱动板 (Core/Src/pca9685.c)
        │  50Hz PWM (500~2500 µs)
        ▼
三路舵机（对应 3-RRS 三条支链）
```

---

## 文件结构

```
tracker_MATLAB_STM32/
├── sun.m               # MATLAB 纯仿真程序（无硬件依赖）
├── sun211.m            # MATLAB 仿真 + 串口控制程序
├── testmotor.ioc       # STM32CubeMX 配置文件
├── Core/
│   ├── Inc/
│   │   ├── main.h
│   │   ├── pca9685.h   # PCA9685 驱动接口声明
│   │   ├── usart.h
│   │   └── i2c.h
│   └── Src/
│       ├── main.c      # STM32 主程序，OnServoCommand() 实现
│       ├── pca9685.c   # PCA9685 I2C 驱动（50Hz PWM 输出）
│       ├── usart.c     # 串口中断接收，指令解析
│       └── i2c.c
├── MDK-ARM/
│   └── testmotor.uvprojx   # Keil MDK 工程文件
└── Drivers/                # STM32 HAL 库
```

---

## 机构参数

| 参数 | 值 | 说明 |
|------|----|------|
| `Rb` | 0.20 m | 静平台连接点半径 |
| `Rp` | 0.12 m | 动平台连接点半径 |
| `h`  | 0.18 m | 初始平台高度 |
| `L1` | 0.10 m | 主动臂长度 |
| `L2` | 0.18 m | 从动臂长度 |
| 最大追踪角度 | ±35° | Roll / Pitch 方向 |

---

## MATLAB 程序说明

### `sun.m` — 纯仿真
- 不依赖硬件，串口连接失败时自动跳过
- 适合在没有硬件时验证 IK 算法和 PID 参数

### `sun211.m` — 仿真 + 硬件控制
- 自动枚举可用串口，或手动指定 `portPref`
- 鼠标在"控制垫"窗口移动即可控制追踪目标方向
- 以 50Hz 频率向 STM32 发送舵机指令，仅角度变化时发送

**三个可视化窗口：**

| 窗口 | 内容 |
|------|------|
| 窗口 1 | 3RRS 机构 3D 动画 + 空中太阳小球 |
| 窗口 2 | 鼠标控制垫（Roll/Pitch 目标输入） |
| 窗口 3 | 三路舵机实时输出角度曲线 |

**串口协议：**
```
S1:090   ← 舵机1，90°
S2:045   ← 舵机2，45°
S3:120   ← 舵机3，120°
```
每条指令以 `\n` 结尾，角度固定三位数字格式。

---

## STM32 固件说明

### 硬件配置
| 外设 | 引脚/配置 |
|------|-----------|
| USART1 | 115200 baud，8N1 |
| I2C1 | 连接 PCA9685（地址 0x40）|
| PCA9685 PWM | 50Hz，通道 0/1/2 对应舵机 1/2/3 |

### 串口指令解析（`usart.c`）
- 中断逐字接收，遇 `\n` 或 `\r` 触发解析
- 格式校验：`S[1-3]:[0-9]{3}`
- 调用 `OnServoCommand(id, angle)` 驱动对应舵机

### PCA9685 驱动（`pca9685.c`）
- `PCA9685_Init50Hz()` — 初始化为 50Hz PWM
- `PCA9685_ServoWriteDeg(addr, ch, deg)` — 角度转脉宽输出
- 脉宽范围：500 µs（0°） ~ 2500 µs（180°）

---

## 快速开始

### 1. 运行纯仿真（无需硬件）
```matlab
% 在 MATLAB 中运行
run('sun.m')
```
移动鼠标至"控制垫"窗口即可观察 3RRS 机构跟随运动。

### 2. 连接硬件运行
1. 将 STM32 固件编译烧录（Keil 工程：`MDK-ARM/testmotor.uvprojx`）
2. 连接 STM32 USB 串口，确认 COM 口号
3. 修改 `sun211.m` 中的串口配置（或留空自动检测）：
   ```matlab
   portPref = "COM5";  % 填入实际 COM 口，留空则自动选择
   ```
4. 在 MATLAB 中运行：
   ```matlab
   run('sun211.m')
   ```

### 3. 舵机角度调零
若舵机初始位置不正确，调节 `sun211.m` 中的映射参数：
```matlab
servoOffset = [90 90 90];   % 各舵机中位角度
servoDir    = [-1 -1 -1];   % 方向：1 或 -1
```

---

## 依赖环境

| 端 | 要求 |
|----|------|
| MATLAB | R2019b 及以上（需支持 `serialport` 函数） |
| Keil MDK | V5，含 STM32F1xx HAL 库 |
| 硬件 | STM32F103 开发板 + PCA9685 模块 + 三路舵机 |

---

## PID 参数调节参考

```matlab
Kp = 0.02;   % 比例项，增大可加快响应速度
Ki = 0;      % 积分项，一般保持 0
Kd = 0;      % 微分项，可适当增大以减少震荡
```
